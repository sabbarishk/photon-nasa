# {{ title }}
# Advanced NASA Data Analysis and Visualization
# Dataset: {{ dataset_url }}
# Variable: {{ variable }}

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# Set style for beautiful plots
plt.style.use('seaborn-v0_8-darkgrid')
sns.set_palette("husl")
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 11

# Load and prepare data
print("ðŸ“Š Loading NASA dataset...")
url = "{{ dataset_url }}"

# Try different parsing strategies for NASA CSV formats
try:
    # Try standard parsing first
    df = pd.read_csv(url)
    print(f"âœ… Loaded {len(df)} records")
    
    # Handle MultiIndex - GISS data stores values IN the MultiIndex
    if isinstance(df.index, pd.MultiIndex):
        print("ðŸ”„ Detected MultiIndex format (GISS-style)")
        
        # Extract data from MultiIndex into a proper DataFrame
        # First row of MultiIndex contains column names
        col_names = list(df.index[0])
        
        # Rest of the rows contain data
        data_rows = [list(idx) for idx in df.index[1:]]
        
        # Create new DataFrame with proper structure
        df = pd.DataFrame(data_rows, columns=col_names)
        print(f"   Restructured to {df.shape[0]} rows Ã— {df.shape[1]} columns")
        print(f"   Columns: {list(df.columns)[:8]}")
        
except Exception as e:
    print(f"âš ï¸  Error loading CSV: {e}")
    # Try skipping rows or different separators
    try:
        df = pd.read_csv(url, skiprows=1)
        print(f"âœ… Loaded {len(df)} records (skipped header row)")
    except:
        df = pd.read_csv(url, sep='\s+')
        print(f"âœ… Loaded {len(df)} records (whitespace separator)")

print(f"\nðŸ“‹ Dataset Info:")
print(f"Shape: {df.shape}")
print(f"Columns: {list(df.columns)[:5]}{'...' if len(df.columns) > 5 else ''}")

# Smart column detection - find the main data column
numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
time_cols = [col for col in df.columns if any(x in str(col).lower() for x in ['year', 'date', 'time'])]

# If no numeric columns, try converting
if len(numeric_cols) == 0:
    print("ðŸ”„ Attempting to convert columns to numeric...")
    for col in df.columns:
        if col not in time_cols:
            df[col] = pd.to_numeric(df[col], errors='coerce')
    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()

print(f"\nðŸ“Š Found {len(numeric_cols)} numeric columns: {numeric_cols[:3]}{'...' if len(numeric_cols) > 3 else ''}")

# Select the main variable
variable = "{{ variable }}"
if variable in df.columns:
    data_col = variable
elif len(numeric_cols) > 0:
    data_col = numeric_cols[0]
    print(f"âš ï¸  Using '{data_col}' as main variable")
else:
    print("âŒ No numeric data found!")
    raise ValueError("No numeric columns available for analysis")

# Prepare time series data
if time_cols:
    time_col = time_cols[0]
    df[time_col] = pd.to_numeric(df[time_col], errors='coerce')
    df = df.dropna(subset=[time_col, data_col])
    years = df[time_col].values
    data = df[data_col].values
    print(f"\nâœ… Prepared {len(data)} data points from {years.min():.0f} to {years.max():.0f}")
else:
    data = df[data_col].dropna().values
    years = np.arange(len(data))
    print(f"\nâœ… Prepared {len(data)} data points")

# Create comprehensive visualization dashboard
fig = plt.figure(figsize=(16, 12))
fig.suptitle('{{ title }} - Comprehensive Analysis', fontsize=18, fontweight='bold', y=0.995)

# 1. Time Series Plot
ax1 = plt.subplot(3, 2, 1)
ax1.plot(years, data, linewidth=2, color='#2E86AB', alpha=0.8, marker='o', markersize=3)
ax1.set_title(f'{data_col} Over Time', fontsize=14, fontweight='bold')
ax1.set_xlabel('Year' if time_cols else 'Index', fontsize=12)
ax1.set_ylabel(data_col, fontsize=12)
ax1.grid(True, alpha=0.3)

# Add trend line
if len(data) > 1:
    z = np.polyfit(years, data, 1)
    p = np.poly1d(z)
    ax1.plot(years, p(years), "--", color='#A23B72', linewidth=2, alpha=0.7, label=f'Trend: {z[0]:.4f}x + {z[1]:.2f}')
    ax1.legend()

# 2. Distribution Histogram with KDE
ax2 = plt.subplot(3, 2, 2)
ax2.hist(data, bins=30, alpha=0.6, color='#F18F01', edgecolor='black', density=True)
if len(data) > 5:
    from scipy import stats
    kde_data = np.linspace(data.min(), data.max(), 200)
    kde = stats.gaussian_kde(data)
    ax2.plot(kde_data, kde(kde_data), color='#C73E1D', linewidth=2, label='KDE')
    ax2.legend()
ax2.set_title('Distribution', fontsize=14, fontweight='bold')
ax2.set_xlabel(data_col, fontsize=12)
ax2.set_ylabel('Density', fontsize=12)
ax2.grid(True, alpha=0.3, axis='y')

# 3. Box Plot
ax3 = plt.subplot(3, 2, 3)
bp = ax3.boxplot(data, vert=True, patch_artist=True, 
                 boxprops=dict(facecolor='#84DCC6', alpha=0.7),
                 medianprops=dict(color='#C73E1D', linewidth=2),
                 whiskerprops=dict(color='#2E86AB', linewidth=1.5),
                 capprops=dict(color='#2E86AB', linewidth=1.5))
ax3.set_title('Box Plot Analysis', fontsize=14, fontweight='bold')
ax3.set_ylabel(data_col, fontsize=12)
ax3.grid(True, alpha=0.3, axis='y')

# Add statistics text
stats_text = f"Mean: {np.mean(data):.3f}\nMedian: {np.median(data):.3f}\nStd: {np.std(data):.3f}"
ax3.text(1.15, np.median(data), stats_text, fontsize=10, bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

# 4. Rolling Statistics (if time series)
ax4 = plt.subplot(3, 2, 4)
if len(data) > 10:
    window = max(5, len(data) // 20)
    rolling_mean = pd.Series(data).rolling(window=window, center=True).mean()
    rolling_std = pd.Series(data).rolling(window=window, center=True).std()
    
    ax4.plot(years, data, 'o-', alpha=0.3, markersize=2, label='Original', color='gray')
    ax4.plot(years, rolling_mean, linewidth=2, label=f'{window}-point Moving Avg', color='#2E86AB')
    ax4.fill_between(years, rolling_mean - rolling_std, rolling_mean + rolling_std, 
                     alpha=0.2, color='#F18F01', label='Â±1 Std Dev')
    ax4.legend()
    ax4.set_title(f'Rolling Statistics (window={window})', fontsize=14, fontweight='bold')
else:
    ax4.plot(years, data, 'o-', linewidth=2, markersize=5, color='#2E86AB')
    ax4.set_title('Data Points', fontsize=14, fontweight='bold')
ax4.set_xlabel('Year' if time_cols else 'Index', fontsize=12)
ax4.set_ylabel(data_col, fontsize=12)
ax4.grid(True, alpha=0.3)

# 5. Statistical Summary Table
ax5 = plt.subplot(3, 2, 5)
ax5.axis('tight')
ax5.axis('off')

stats_data = [
    ['Metric', 'Value'],
    ['Count', f'{len(data)}'],
    ['Mean', f'{np.mean(data):.4f}'],
    ['Median', f'{np.median(data):.4f}'],
    ['Std Dev', f'{np.std(data):.4f}'],
    ['Min', f'{np.min(data):.4f}'],
    ['Max', f'{np.max(data):.4f}'],
    ['Range', f'{np.max(data) - np.min(data):.4f}'],
    ['Variance', f'{np.var(data):.4f}'],
]

table = ax5.table(cellText=stats_data, cellLoc='left', loc='center',
                 colWidths=[0.4, 0.6])
table.auto_set_font_size(False)
table.set_fontsize(11)
table.scale(1, 2)

# Style header row
for i in range(2):
    table[(0, i)].set_facecolor('#2E86AB')
    table[(0, i)].set_text_props(weight='bold', color='white')

# Alternate row colors
for i in range(1, len(stats_data)):
    for j in range(2):
        if i % 2 == 0:
            table[(i, j)].set_facecolor('#E8F4F8')
        table[(i, j)].set_edgecolor('#2E86AB')

ax5.set_title('Statistical Summary', fontsize=14, fontweight='bold', pad=20)

# 6. Year-over-Year Change (if time series with enough data)
ax6 = plt.subplot(3, 2, 6)
if len(data) > 2 and time_cols:
    changes = np.diff(data)
    change_years = years[1:]
    colors = ['#84DCC6' if c >= 0 else '#C73E1D' for c in changes]
    ax6.bar(change_years, changes, color=colors, alpha=0.7, edgecolor='black')
    ax6.axhline(y=0, color='black', linestyle='-', linewidth=0.8)
    ax6.set_title('Year-over-Year Change', fontsize=14, fontweight='bold')
    ax6.set_xlabel('Year', fontsize=12)
    ax6.set_ylabel(f'Change in {data_col}', fontsize=12)
    ax6.grid(True, alpha=0.3, axis='y')
else:
    # Correlation with multiple variables if available
    if len(numeric_cols) > 1:
        corr_df = df[numeric_cols].corr()
        sns.heatmap(corr_df, annot=True, fmt='.2f', cmap='coolwarm', center=0,
                   square=True, ax=ax6, cbar_kws={'shrink': 0.8})
        ax6.set_title('Correlation Matrix', fontsize=14, fontweight='bold')
    else:
        ax6.text(0.5, 0.5, f'Total Records: {len(data)}\nData Range: {years.min():.0f} - {years.max():.0f}',
                ha='center', va='center', fontsize=14, transform=ax6.transAxes,
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))
        ax6.axis('off')
        ax6.set_title('Dataset Overview', fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

print("\nâœ… Comprehensive visualization dashboard complete!")
print(f"ðŸ“Š Analyzed {len(data)} data points")
print(f"ðŸ“ˆ Mean: {np.mean(data):.4f}, Std: {np.std(data):.4f}")
print(f"ðŸ“‰ Range: [{np.min(data):.4f}, {np.max(data):.4f}]")
